services:
  nginx:
    image: nginx
    container_name: fermento-nginx
    build: ../nginx
    restart: unless-stopped
    ports:
      - 80:80
    volumes:
      - ../nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - services
    depends_on:
      - frontend
      - api

  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: fermento-mosquitto
    environment:
      - TZ=Europe/Madrid
    volumes:
      - ../mosquitto/volume/config:/mosquitto/config
      - ../mosquitto/volume/data:/mosquitto/data
      - ../mosquitto/volume/log:/mosquitto/log
    ports:
      - 1883:1883
      - 9001:9001
    networks:
      - services
    restart: unless-stopped

  frontend:
    image: fermento-frontend
    container_name: fermento-frontend
    build: ../frontend
    restart: unless-stopped
    environment:
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_ENABLESTATICSERVING=true
      - STREAMLIT_SERVER_BASEURLPATH=/fermento/v1
    ports:
      - 8501:8501
    networks:
      - services

  api:
    image: fermento-api
    container_name: fermento-api
    build: ../api
    restart: unless-stopped
    environment:
      - API_ROOT_PATH=/src/data/
      - API_DB_URL=sqlite:////src/data/database.db
      - API_LOG_LEVEL=DEBUG
    ports:
      - 8091:8091
    volumes:
      - ../api/data/:/src/data/
      - ../api/src/migrations/versions:/src/migrations/versions/
    networks:
      - services

  ingestor:
    image: fermento-ingestor
    container_name: fermento-ingestor
    build: ../ingestor
    restart: unless-stopped
    environment:
      - API_ADDRESS=http://localhost:8091
      - BROKER_ADDRESS=localhost
      - BROKER_PORT=1883
      - TOPIC_TELEMETRY=fermento/+/telemetry
      - TOPIC_STATUS=fermento/+/status
    ports:
      - 8091:8091
    volumes:
      - ../api/data/:/src/data/
      - ../api/src/migrations/versions:/src/migrations/versions/
    networks:
      - services

networks:
  services:
    driver: bridge
